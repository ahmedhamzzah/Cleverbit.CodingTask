<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <title>Cleverbit Coding Task</title>
    <script>

        function generateNumerForUser() {
            let number = getRandomNumbers(0, 100);
            $('#gameNumber').val(number);
            $('#btnPlayNow').hide();
        }

        function getRandomNumbers(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function enableOrDisablePlayButtons(show) {
            if (!show) {
                $('#btnPlayNow').prop('disabled', true);
                $('#btnSubmit').prop('disabled', true);
            } else {
                $('#btnPlayNow').prop('disabled', false);
                $('#btnSubmit').prop('disabled', false);
            }
        }

        function goToLoginPage() {
            window.location.href = "/Views/Login.html";
        }

        $(document).ready(function () {

            if (!localStorage.getItem('authorization'))
                goToLoginPage();

            function handleAvailableMatchSuccess(data) {
                if (data) {
                    $('#matchId').val(data.id);
                    $('#mathcName').text(data.matchName);
                    let expireDate = new Date(data.expireDate);
                    $('#matchExpireDate').text(expireDate.toLocaleDateString() + ' ' + expireDate.toLocaleTimeString());
                    enableOrDisablePlayButtons(true);
                } else {
                    enableOrDisablePlayButtons(false);
                }
            }

            function handleAvailableMatchError(xhr, ajaxOptions, thrownError) {
                if (xhr.status == 401) {
                    localStorage.clear();
                    goToLoginPage();
                }
            }


            function getAvailableMatch() {
                $.ajax({
                    type: "GET",
                    url: "/api/Match/GetAvailableMatch",
                    headers: {
                        "Authorization": "Basic " + localStorage.getItem('authorization')
                    },
                    success: handleAvailableMatchSuccess,
                    error: handleAvailableMatchError
                })
            }

            getAvailableMatch();


            $('#mathcForm').submit(function (e) {

                e.preventDefault();

                $.ajax({
                    type: "POST",
                    url: "/api/Match/Submit",
                    data: JSON.stringify(userData),
                    headers: {
                        "Authorization": "Basic " + localStorage.getItem('authorization')
                    },
                    success: SubmitMatchResult
                })
            });

        });
    </script>
</head>
<body>
    <form id="mathcForm" class="form-inline container" style="padding-top: 30px">

        <input type="hidden" id="matchId" name="matchId" />

        <div class="row">
            <p>Available Match:  <label id="mathcName"></label> </p>

            <p>Expire On:  <label id="matchExpireDate"></label> </p>
        </div>

        <div class="form-group mb-2 row">
            <label for="pingWithoutAuthLabel" class="sr-only">Ping Without Auth</label>
            <input type="text" readonly class="form-control-plaintext" id="gameNumber" value="Ping Without Auth">
        </div>
        <button type="button" class="btn btn-primary mb-6" id="btnPlayNow" onclick="generateNumerForUser();" disabled>Play Now</button>

        <button type="submit" class="btn btn-primary mb-6" id="btnSubmit" onclick="getPingWithAuth(); return false;" disabled>Submit</button>
    </form>
</body>
</html>